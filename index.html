<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>MC TETRIS — Classroom Edition</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
  <link href="https://fonts.googleapis.com/css2?family=Courier+Prime:wght@400;700&family=JetBrains+Mono:wght@400;500;700&display=swap" rel="stylesheet"/>

  <style>
    /* ===========================================================
       MC TETRIS — Single-file build (HTML + CSS + JS inline)
       =========================================================== */

    :root{
      /* Theme variables; JS will update these live */
      --bg-url: none;            /* set to url("assets/xxx.jpg") if present */
      --ink:#0af7a3;             /* neon green */
      --cyan:#07e1ff;            /* accent cyan */
      --amber:#ffb000;
      --violet:#7a5cff;
      --space:#070a16;

      /* Board sizing (mobile-friendly) */
      --board-w: 320px;
      --board-h: 640px;
    }

    *{box-sizing:border-box; margin:0; padding:0}
    html,body{height:100%}
    body{
      font-family:'JetBrains Mono','Courier Prime',monospace;
      background: var(--space);
      color:#00ffb2;
      min-height:100vh; padding:1rem; overflow-x:hidden; position:relative;
    }

    /* ---------------- Background System ---------------- */
    .mc-bg{ position:fixed; inset:0; z-index:-2; pointer-events:none; overflow:hidden; }
    .mc-art{
      position:absolute; inset:-2%;
      background: var(--bg-url), radial-gradient(120% 120% at 50% 10%, rgba(5,12,22,.9), rgba(3,8,16,1));
      background-size: cover;
      background-position: center;
      filter: saturate(1.05) contrast(1.02) brightness(.95);
      animation:mcDrift 22s ease-in-out infinite alternate;
    }
    @keyframes mcDrift{ from{transform:scale(1.02)} to{transform:scale(1.06) translate(-2%,2%)} }

    .mc-aurora{
      position:absolute; inset:-10%;
      background:
        radial-gradient(40% 60% at 20% 10%, rgba(122,92,255,.28) 0%, transparent 60%),
        radial-gradient(48% 58% at 80% 0%, rgba(7,225,255,.22) 0%, transparent 60%),
        radial-gradient(46% 62% at 80% 80%, rgba(18,255,176,.20) 0%, transparent 70%);
      filter: blur(28px) saturate(120%);
      animation:mcAurora 14s ease-in-out infinite alternate;
    }
    @keyframes mcAurora{ 0%{transform:none} 100%{transform:translate(-2%,2%) scale(1.04)} }

    .mc-scan{
      position:absolute; inset:0;
      background: linear-gradient(transparent 50%, rgba(0,0,0,.18) 50%);
      background-size:100% 3px; opacity:.25;
    }
    .mc-vignette{
      position:absolute; inset:0;
      background: radial-gradient(120% 120% at 50% 25%, transparent 55%, rgba(0,0,0,.45) 90%),
                  radial-gradient(100% 100% at 50% 120%, rgba(0,0,0,.55), transparent 50%);
      mix-blend-mode:multiply;
    }
    .mc-watermark{
      position:absolute; right:12px; bottom:10px; user-select:none;
      font-weight:800; letter-spacing:.25rem; font-size:.75rem;
      color:rgba(18,255,176,.22); text-shadow:0 0 8px rgba(18,255,176,.25);
    }

    /* ---------------- Layout ---------------- */
    .container{max-width:1200px; margin:0 auto; position:relative;}
    .title{
      text-align:center; font-size:3rem; font-weight:800; letter-spacing:.6rem; margin-bottom:2rem;
      color:#b6fff1;
      text-shadow:0 0 10px var(--ink), 0 0 24px var(--ink), 0 0 48px var(--cyan);
      animation:glow 2s ease-in-out infinite alternate;
    }
    @keyframes glow{
      from{ text-shadow:0 0 18px var(--ink),0 0 28px var(--cyan) }
      to{ text-shadow:0 0 26px var(--ink),0 0 40px var(--cyan) }
    }
    .game-layout{ display:grid; grid-template-columns:1fr auto 1fr; gap:2rem; align-items:start; }

    /* ---------------- Board & Cells ---------------- */
    .game-board{
      width:var(--board-w); height:var(--board-h);
      border:4px solid rgba(18,255,176,.8); border-radius:8px;
      background: radial-gradient(120% 120% at 50% 10%, rgba(5,12,22,.9), rgba(3,8,16,1));
      box-shadow: 0 0 24px rgba(18,255,176,.35), inset 0 0 24px rgba(18,255,176,.08), 0 0 80px rgba(7,225,255,.08);
      display:grid; grid-template-columns:repeat(10,1fr); grid-template-rows:repeat(20,1fr);
      gap:1px; padding:4px; justify-self:center;
    }
    .game-cell{ background:#000; border:1px solid rgba(26,42,68,.55); transition:background-color .08s ease, box-shadow .12s ease, opacity .12s ease; }
    .game-cell.filled{ box-shadow: inset 0 0 12px rgba(255,255,255,.28); }
    .game-cell.ghost{ background: rgba(18,255,176,.18)!important; border-color: transparent; }
    .game-cell.ghost.lockPulse{ background: rgba(18,255,176,.32)!important; opacity:.9; animation:ghostPulse .35s ease-in-out infinite alternate; }
    @keyframes ghostPulse{ from{opacity:.55} to{opacity:.9} }
    .row-flash{ animation:rowFlash .18s ease-in-out 2; }
    @keyframes rowFlash{ 0%{background:#000} 50%{background:#9dff9d} 100%{background:#000} }

    /* ---------------- Panels & UI ---------------- */
    .side-panel{
      background: linear-gradient(180deg, rgba(12,18,32,.72), rgba(8,12,24,.72));
      border:2px solid rgba(18,255,176,.65); border-radius:8px; padding:1.5rem;
      box-shadow: 0 0 24px rgba(18,255,176,.25), inset 0 0 28px rgba(0,0,0,.35);
    }
    .panel-title{ font-size:1.1rem; font-weight:800; text-align:center; margin-bottom:1rem; color:#b6fff1; text-shadow:0 0 8px rgba(18,255,176,.45); }
    .score-item{ display:flex; justify-content:space-between; margin-bottom:.5rem; font-size:.9rem; }
    .score-value{ color: var(--cyan); font-weight:800; }

    .mini-grid{ width:96px; height:96px; border:2px solid #004400; border-radius:4px; background:#000; margin:.5rem auto;
      display:grid; grid-template-columns:repeat(4,1fr); grid-template-rows:repeat(4,1fr); gap:1px; padding:4px; }
    .preview-cell{ background:#000; border-radius:1px; }
    .mini-list{ display:grid; grid-template-columns:repeat(1,1fr); gap:.5rem; justify-items:center; }

    .controls{ display:flex; flex-direction:column; gap:1rem; }
    .btn{
      background: rgba(10,16,28,.85);
      border:2px solid rgba(18,255,176,.6);
      color: var(--ink);
      padding:.75rem 1rem; border-radius:4px; font-weight:700; cursor:pointer; transition:.15s; text-transform:uppercase;
    }
    .btn:hover:not(:disabled){ background: rgba(12,20,36,1); border-color: var(--cyan); box-shadow: 0 0 14px rgba(7,225,255,.45); }
    .btn:disabled{ opacity:.5; cursor:not-allowed; }
    .btn-primary{ background: linear-gradient(180deg,#0a3,#092); color:#fff; }
    .hidden{ display:none !important; }

    .opt{ display:grid; grid-template-columns:auto 1fr; gap:.5rem .75rem; align-items:center; font-size:.8rem; margin-top:.75rem; }
    .opt input[type="number"], .opt select{
      background:#0a0a0a; color:#9fffbf; border:1px solid #044; border-radius:4px; padding:.3rem .4rem; width:100%;
    }
    .opt input[type="range"]{ width:100%; }

    .modal{ position:fixed; inset:0; background:rgba(0,0,0,.9); display:flex; align-items:center; justify-content:center; z-index:1000; padding:1rem; }
    .modal-content{ background:#111; border:4px solid rgba(18,255,176,.8); border-radius:8px; padding:2rem; text-align:center; max-width:720px; width:100%; box-shadow:0 0 30px rgba(0,255,176,.5); }
    .modal-title{ font-size:2.2rem; font-weight:900; margin-bottom:1rem; color:#b6fff1; text-shadow:0 0 15px var(--ink); }
    .modal-text{ margin-bottom:1.1rem; color:#00cccc; }
    .modal-stats{ margin:1rem 0; display:grid; grid-template-columns:repeat(3,1fr); gap:1rem; }
    .stat-item{ background:#000; border:1px solid #044; border-radius:4px; padding:.5rem; }
    .stat-value{ font-size:1.2rem; font-weight:900; color:var(--cyan); }
    .stat-label{ font-size:.8rem; color:#0a0; }

    .kbd-grid{display:grid; grid-template-columns:1fr 1fr; gap:.6rem .8rem; margin-top:.5rem; text-align:left}
    .kbd-grid label{font-size:.85rem}
    .kbd-grid input{background:#0a0a0a; color:#9fffbf; border:1px solid #044; border-radius:4px; padding:.3rem .4rem}

    .tut-body{ text-align:left; font-size:.95rem; color:#9fffbf; }
    .tut-body .tut-list{ margin-left:1rem; margin-top:.4rem; }
    .tut-nav{ display:flex; justify-content:center; gap:.6rem; margin-top:1rem; }

    /* Tetromino colors */
    .color-I{ background:#00f0ff !important; }
    .color-O{ background:#ffd900 !important; }
    .color-T{ background:#9d63ff !important; }
    .color-S{ background:#15ff76 !important; }
    .color-Z{ background:#ff4b4b !important; }
    .color-J{ background:#4a74ff !important; }
    .color-L{ background:#ff9a2b !important; }

    @media (max-width:1024px){
      .game-layout{ grid-template-columns:1fr; gap:1.5rem; }
      .title{ font-size:2.5rem; letter-spacing:.3rem; }
    }
    @media (max-width:640px){
      :root{ --board-w:280px; --board-h:560px; }
      .title{ font-size:2rem; letter-spacing:.2rem; }
      .modal-title{ font-size:2rem; }
      .mc-watermark{ font-size:.6rem; letter-spacing:.18rem; }
    }
  </style>
</head>

<body>
  <!-- McStephen background stack -->
  <div class="mc-bg">
    <div class="mc-art"></div>
    <div class="mc-aurora"></div>
    <div class="mc-scan"></div>
    <div class="mc-vignette"></div>
    <div class="mc-watermark">MCSTEPHEN</div>
  </div>

  <div class="container">
    <h1 class="title">M C  T E T R I S</h1>

    <div class="game-layout">
      <!-- Left Panel -->
      <div class="side-panel">
        <div class="panel-title">SCORE</div>
        <div class="score-item"><span>Score:</span><span class="score-value" id="score">0</span></div>
        <div class="score-item"><span>Lines:</span><span class="score-value" id="lines">0</span></div>
        <div class="score-item"><span>Level:</span><span class="score-value" id="level">1</span></div>

        <div class="panel-title" style="margin-top:1.2rem;">HOLD</div>
        <div class="mini-grid" id="holdBox"></div>

        <div class="panel-title" style="margin-top:1.2rem;">NEXT</div>
        <div class="mini-list" id="nextList">
          <div class="mini-grid"></div>
          <div class="mini-grid"></div>
          <div class="mini-grid"></div>
          <div class="mini-grid"></div>
          <div class="mini-grid"></div>
        </div>
      </div>

      <!-- Board -->
      <div class="game-board" id="gameBoard"></div>

      <!-- Right Panel -->
      <div class="side-panel">
        <div class="panel-title">CONTROLS</div>
        <div class="controls">
          <button class="btn btn-primary" id="startBtn">START GAME</button>
          <button class="btn hidden" id="pauseBtn">PAUSE</button>
          <button class="btn" id="rotateBtn">ROTATE</button>
          <button class="btn" id="dropBtn">HARD DROP</button>
          <button class="btn" id="holdBtn">HOLD</button>
          <button class="btn" id="keysBtn">KEY BINDS</button>
          <button class="btn" id="tutorialBtn">TUTORIAL</button>
        </div>

        <div class="panel-title" style="margin-top:1rem;">KEYS</div>
        <div style="font-size:.85rem; line-height:1.5;">
          <div>← → : Move &nbsp; | &nbsp; ↓ : Soft Drop</div>
          <div>↑ / Space : Rotate &nbsp; | &nbsp; Enter: Hard Drop</div>
          <div>C / Shift : Hold &nbsp; | &nbsp; P : Pause</div>
        </div>

        <div class="panel-title" style="margin-top:1.2rem;">THEME</div>
        <select id="themeSelect" class="btn" style="text-transform:none;"></select>

        <div class="panel-title" style="margin-top:1.2rem;">MC CLASSROOM</div>
        <div class="opt">
          <label><input type="checkbox" id="optAdaptive" checked/> Adaptive Mode</label><span></span>
          <label>Lock Delay</label><input type="range" id="optLock" min="200" max="800" value="500"/>
          <label>Daily Seed</label><input type="checkbox" id="optDaily"/>
          <label>Seed</label><input type="number" id="optSeed" value="0" min="0" step="1"/>
          <label>Queue Size</label>
          <select id="optQueue"><option>5</option><option>4</option><option>3</option></select>
          <label><input type="checkbox" id="optGhost" checked/> Ghost Piece</label><span></span>
          <label><input type="checkbox" id="optSymbolic"/> Symbolic Score Boost</label><span></span>
          <label><input type="checkbox" id="optMusic" checked/> Music</label><span></span>
          <button class="btn" id="exportBtn">Export CSV</button><span></span>
        </div>
      </div>
    </div>

    <!-- Start Modal -->
    <div class="modal" id="startModal">
      <div class="modal-content">
        <div class="modal-title">T  E  T  R  I  S</div>
        <div class="modal-text">Classic puzzle — SRS, T-Spins, Perfect Clears, MC classroom analytics, and a guided tutorial.</div>
        <div style="display:flex; gap:.6rem; flex-wrap:wrap;">
          <button class="btn" onclick="openTutorial()" style="flex:1;">TUTORIAL</button>
          <button class="btn btn-primary" onclick="startGame()" style="flex:1;">START GAME</button>
        </div>
        <div style="margin-top:1rem; font-size:.8rem; opacity:.7;">Press SPACE or ENTER to start</div>
      </div>
    </div>

    <!-- Game Over Modal -->
    <div class="modal hidden" id="gameOverModal">
      <div class="modal-content">
        <div class="modal-title">GAME OVER</div>
        <div class="modal-stats">
          <div class="stat-item"><div class="stat-value" id="finalScore">0</div><div class="stat-label">SCORE</div></div>
          <div class="stat-item"><div class="stat-value" id="finalLines">0</div><div class="stat-label">LINES</div></div>
          <div class="stat-item"><div class="stat-value" id="finalLevel">1</div><div class="stat-label">LEVEL</div></div>
          <div class="stat-item"><div class="stat-value" id="finalLPM">0</div><div class="stat-label">LPM</div></div>
          <div class="stat-item"><div class="stat-value" id="finalTSpins">0</div><div class="stat-label">T-SPINS</div></div>
          <div class="stat-item"><div class="stat-value" id="finalPCs">0</div><div class="stat-label">PERFECT CLEARS</div></div>
        </div>
        <button class="btn btn-primary" onclick="startGame()" style="width:100%;">PLAY AGAIN</button>
        <div style="margin-top:1rem; font-size:.8rem; opacity:.7;">Press SPACE or ENTER to start a new game</div>
      </div>
    </div>

    <!-- Pause Modal -->
    <div class="modal hidden" id="pauseModal">
      <div class="modal-content">
        <div class="modal-title">PAUSED</div>
        <div class="modal-text">Press P to continue</div>
      </div>
    </div>

    <!-- Keybinds Modal -->
    <div class="modal hidden" id="keysModal">
      <div class="modal-content">
        <div class="modal-title">KEY BINDS</div>
        <div class="kbd-grid">
          <label>Left</label><input id="kbLeft"  placeholder="ArrowLeft"/>
          <label>Right</label><input id="kbRight" placeholder="ArrowRight"/>
          <label>Soft Drop</label><input id="kbDown"  placeholder="ArrowDown"/>
          <label>Rotate</label><input id="kbRotate" placeholder="ArrowUp / Space"/>
          <label>Hard Drop</label><input id="kbHard"  placeholder="Enter"/>
          <label>Hold</label><input id="kbHold"  placeholder="C / Shift"/>
          <label>Pause</label><input id="kbPause" placeholder="P"/>
        </div>
        <div style="display:flex; gap:.6rem; justify-content:center; margin-top:1rem;">
          <button class="btn" id="kbCancel">Cancel</button>
          <button class="btn btn-primary" id="kbSave">Save</button>
        </div>
      </div>
    </div>

    <!-- Tutorial Modal -->
    <div class="modal hidden" id="tutorialModal">
      <div class="modal-content" style="max-width:720px;">
        <div class="modal-title">TUTORIAL</div>
        <div id="tutBody" class="tut-body"></div>
        <div class="tut-nav">
          <button class="btn" id="tutPrev">Back</button>
          <button class="btn" id="tutExit">Exit</button>
          <button class="btn btn-primary" id="tutNext">Next</button>
        </div>
      </div>
    </div>
  </div>

  <script>
  /************************************************************
   * MC TETRIS — Core Game + Theme + Google Drive Assets
   ************************************************************/

  /* ---------- GOOGLE DRIVE ASSETS ---------- */
  const MUSIC_TRACKS = [
    'https://drive.google.com/uc?export=download&id=14i0MDJLeX0XTMkw__eiOTwzvW1kQAvbT',
    'https://drive.google.com/uc?export=download&id=1BsADbL5IZ1zceHZdAqXl49G_2w55j6N3',
    'https://drive.google.com/uc?export=download&id=1G9hoI0wvyuMf782YJwzuY4TUdYt4fzAa',
    'https://drive.google.com/uc?export=download&id=1LKmTHfaAbLnUVYXmEtbPV_KOX3rR4nYa',
    'https://drive.google.com/uc?export=download&id=1LXngrT6aXS5AQeApvWBMWWxOggadVm5w',
    'https://drive.google.com/uc?export=download&id=1QvFeUMLPwJrB-G4zDFsMRyPNivCBsRgc',
    'https://drive.google.com/uc?export=download&id=1RPnqNC8hr8VG2PZ5UALZa_wIaQDhoOuP',
    'https://drive.google.com/uc?export=download&id=1fhhIaEXbV4sEtgr_X02BUyI03iB2UIb-',
    'https://drive.google.com/uc?export=download&id=1hYjBGuxSNfAiqI186lxu4p4BTJW8HDj9',
    'https://drive.google.com/uc?export=download&id=1mJegAdvASXzhPaoM8_y4oDBTBTQAQ-JE',
    'https://drive.google.com/uc?export=download&id=1oFr2T8QNRE0SbK-s4ZhtS1X1Lwupl5ma',
    'https://drive.google.com/uc?export=download&id=1tQhU6VMiE8ZtNlsr6r55ZqEoAwrdqXNE',
    'https://drive.google.com/uc?export=download&id=1zVoHI01OiRoJy_VB8dcOsvrGaDfuXCtV'
  ];

  const BACKGROUND_IMAGES = [
    'https://drive.google.com/uc?export=download&id=10mHqB22OdDKhUSFgoWu8mFK6V1vMt84p',
    'https://drive.google.com/uc?export=download&id=19jAl5Mwj7hMi3wPxSA460IX6DcYFcvtx',
    'https://drive.google.com/uc?export=download&id=1BjrJTHSGDv7UShRSNvUKe9BkdGsb6M5U',
    'https://drive.google.com/uc?export=download&id=1FZYOFDsmlF5AIdkuyl6Q9r4YYzKQRaXT',
    'https://drive.google.com/uc?export=download&id=1M6yOLdM75lqTeoOWnv3ovSHGI6pqY5NB',
    'https://drive.google.com/uc?export=download&id=1OinrK5o7Li0Qp-oOcdOoeVtQChjAPcuN',
    'https://drive.google.com/uc?export=download&id=1SIbvz4AFBBdqTDz37GW7qZBuchvumoqp',
    'https://drive.google.com/uc?export=download&id=1TPcLWVTBfjTlgBROxqGR5rDVkPHjSSA8',
    'https://drive.google.com/uc?export=download&id=1ZpgIeLk4fUECzsnM9vY99zjpy0XnHLpO',
    'https://drive.google.com/uc?export=download&id=1cv07EwlFPR13Ks43A-FAtfmTw2saj7EA',
    'https://drive.google.com/uc?export=download&id=1eacVPuPun3YQtdxaI2cLub487YzLlhAQ',
    'https://drive.google.com/uc?export=download&id=1pI2EAmUCrwQIJnQ1kcFsj0WNj2AFaygr',
    'https://drive.google.com/uc?export=download&id=1q0WVyEvbiMiRToSpdhFrQNPY4FBl8Dfh',
    'https://drive.google.com/uc?export=download&id=1sYPrZTFoAflzYYNItrTH65vjHjd2hYRK',
    'https://drive.google.com/uc?export=download&id=1uDYEqNraOwverBqgbe9t8qBHERnyAC3x',
    'https://drive.google.com/uc?export=download&id=1yYsg6S5EBn045j4kmCdXVRI0OD1jlezJ'
  ];

  let currentMusic = null;

  /* ---------- Safe DOM Helpers ---------- */
  function mustGet(id){ const el=document.getElementById(id); if(!el) throw new Error('Missing #' + id); return el; }
  const store={ get:(k,f="{}")=>{try{return localStorage.getItem(k)??f}catch{return f}}, set:(k,v)=>{try{localStorage.setItem(k,v);return true}catch{return false}}};

  /* ---------- Constants ---------- */
  const BOARD_WIDTH=10, BOARD_HEIGHT=20;
  const INITIAL_SPEED=500; // ms per gravity tick at level 1
  let LOCK_DELAY=500;      // ms; adjustable via slider

  const SOFT_POINT=1, HARD_POINT=2;
  const LINE_SCORE=[0,100,300,500,800]; // single..tetris
  const TSPIN_BONUS=400;
  const PERFECT_CLEAR_BONUS=1800;

  // Pieces
  const TETROMINOES={
    I:{shape:[[0,0,0,0],[1,1,1,1],[0,0,0,0],[0,0,0,0]],class:'color-I',id:1},
    O:{shape:[[1,1],[1,1]],class:'color-O',id:3},
    T:{shape:[[0,1,0],[1,1,1],[0,0,0]],class:'color-T',id:2},
    S:{shape:[[0,1,1],[1,1,0],[0,0,0]],class:'color-S',id:4},
    Z:{shape:[[1,1,0],[0,1,1],[0,0,0]],class:'color-Z',id:5},
    J:{shape:[[1,0,0],[1,1,1],[0,0,0]],class:'color-J',id:6},
    L:{shape:[[0,0,1],[1,1,1],[0,0,0]],class:'color-L',id:7}
  };
  const TYPES=Object.keys(TETROMINOES);

  /* ---------- SRS Kicks ---------- */
  const SRS_JLSTZ = {
    '0>1': [[0,0],[-1,0],[-1,-1],[0,2],[-1,2]],
    '1>0': [[0,0],[1,0],[1,1],[0,-2],[1,-2]],
    '1>2': [[0,0],[1,0],[1,1],[0,-2],[1,-2]],
    '2>1': [[0,0],[-1,0],[-1,-1],[0,2],[-1,2]],
    '2>3': [[0,0],[1,0],[1,-1],[0,2],[1,2]],
    '3>2': [[0,0],[-1,0],[-1,1],[0,-2],[-1,-2]],
    '3>0': [[0,0],[-1,0],[-1,1],[0,-2],[-1,-2]],
    '0>3': [[0,0],[1,0],[1,-1],[0,2],[1,2]]
  };
  const SRS_I = {
    '0>1': [[0,0],[-2,0],[1,0],[-2,1],[1,-2]],
    '1>0': [[0,0],[2,0],[-1,0],[2,-1],[-1,2]],
    '1>2': [[0,0],[-1,0],[2,0],[-1,-2],[2,1]],
    '2>1': [[0,0],[1,0],[-2,0],[1,2],[-2,-1]],
    '2>3': [[0,0],[2,0],[-1,0],[2,-1],[-1,2]],
    '3>2': [[0,0],[-2,0],[1,0],[-2,1],[1,-2]],
    '3>0': [[0,0],[1,0],[-2,0],[1,2],[-2,-1]],
    '0>3': [[0,0],[-1,0],[2,0],[-1,-2],[2,1]]
  };

  /* ---------- UI Refs ---------- */
  const gameBoard=mustGet('gameBoard');
  const startModal=mustGet('startModal');
  const gameOverModal=mustGet('gameOverModal');
  const pauseModal=mustGet('pauseModal');
  const keysModal=mustGet('keysModal');
  const tutorialModal=mustGet('tutorialModal');

  const startBtn=mustGet('startBtn');
  const pauseBtn=mustGet('pauseBtn');
  const rotateBtn=mustGet('rotateBtn');
  const dropBtn=mustGet('dropBtn');
  const holdBtn=mustGet('holdBtn');
  const keysBtn=mustGet('keysBtn');
  const tutorialBtn=mustGet('tutorialBtn');

  const scoreEl=mustGet('score');
  const linesEl=mustGet('lines');
  const levelEl=mustGet('level');
  const holdBox=mustGet('holdBox');
  const nextList=mustGet('nextList');

  const optAdaptive=mustGet('optAdaptive');
  const optLock=mustGet('optLock');
  const optDaily=mustGet('optDaily');
  const optSeed=mustGet('optSeed');
  const optQueue=mustGet('optQueue');
  const optGhost=mustGet('optGhost');
  const optSymbolic=mustGet('optSymbolic');
  const optMusic=mustGet('optMusic');
  const exportBtn=mustGet('exportBtn');

  const kb = {
    modal: keysModal,
    left: mustGet('kbLeft'),
    right: mustGet('kbRight'),
    down: mustGet('kbDown'),
    rotate: mustGet('kbRotate'),
    hard: mustGet('kbHard'),
    hold: mustGet('kbHold'),
    pause: mustGet('kbPause'),
    save: mustGet('kbSave'),
    cancel: mustGet('kbCancel')
  };

  const tut = {
    modal: tutorialModal,
    body: mustGet('tutBody'),
    next: mustGet('tutNext'),
    prev: mustGet('tutPrev'),
    exit: mustGet('tutExit'),
    step: 0, active:false, practiceMode:false
  };

  /* ---------- Audio (tiny WebAudio beeps + Music) ---------- */
  let AC=null; function ac(){ if(!AC){ AC=new (window.AudioContext||window.webkitAudioContext)(); } return AC; }
  function beep(freq=440, dur=0.06, gain=0.03){ try{ const c=ac(); const o=c.createOscillator(), g=c.createGain(); o.type='square'; o.frequency.value=freq; g.gain.value=gain; o.connect(g); g.connect(c.destination); const t=c.currentTime; o.start(t); o.stop(t+dur);}catch{} }
  const SND={ rotate:()=>beep(740,0.05,0.025), move:()=>beep(520,0.03,0.02), drop:()=>beep(960,0.05,0.03),
              line:()=>beep(420,0.06,0.035), tspin:()=>beep(300,0.12,0.05), pc:()=>beep(220,0.18,0.06), over:()=>beep(160,0.25,0.06) };

  function stopMusic(){ 
    if(currentMusic){ 
      currentMusic.pause(); 
      currentMusic.currentTime = 0; 
      currentMusic = null;
    }
  }

  function playMusicForLevel(level){ 
    if(!optMusic.checked) return;
    stopMusic();
    const trackIndex = (level - 1) % MUSIC_TRACKS.length;
    const trackUrl = MUSIC_TRACKS[trackIndex];
    currentMusic = new Audio(trackUrl);
    currentMusic.loop = true;
    currentMusic.volume = 0.25;
    currentMusic.play().catch(e => console.warn('Music play blocked:', e));
    console.log(`🎵 Playing track ${trackIndex + 1}/${MUSIC_TRACKS.length} for level ${level}`);
  }

  /* ---------- State ---------- */
  let state={};
  let rngSeed=Math.floor(Math.random()*1e9)>>>0;
  let queue=[], canHold=true, lockSince=null, loopHandle=0;
  let lastActionWasRotate=false;

  // Stats
  let sessionStart=Date.now();
  const stats={ tspins:0, perfects:0 };
  const roll={ inputs:0, soft:0, hard:0, mis:0, locks:0, lastInputAt:performance.now(), meanLatency:0 };
  const CLASS_KEY='mc_tetris_classlog';

  /* ---------- RNG + 7-bag ---------- */
  function dailySeed(){ const d=new Date(); return (d.getFullYear()*10000+(d.getMonth()+1)*100+d.getDate())>>>0; }
  function xs32(){ rngSeed^=rngSeed<<13; rngSeed^=rngSeed>>>17; rngSeed^=rngSeed<<5; return (rngSeed>>>0)/0xffffffff; }
  function newBag(){ const arr=[1,2,3,4,5,6,7]; for(let i=arr.length-1;i>0;i--){ const j=Math.floor(xs32()*(i+1)); [arr[i],arr[j]]=[arr[j],arr[i]]; } return arr.map(id=>TYPES.find(k=>TETROMINOES[k].id===id)); }

  /* ---------- Board Helpers ---------- */
  function makeBoard(){
    gameBoard.innerHTML='';
    state.board = Array.from({length:BOARD_HEIGHT},()=>Array.from({length:BOARD_WIDTH},()=>null));
    const frag=document.createDocumentFragment();
    for(let y=0;y<BOARD_HEIGHT;y++){
      for(let x=0;x<BOARD_WIDTH;x++){
        const cell=document.createElement('div');
        cell.className='game-cell'; cell.dataset.x=String(x); cell.dataset.y=String(y);
        frag.appendChild(cell);
      }
    }
    gameBoard.appendChild(frag);
  }
  function spawnPiece(type){ const d=TETROMINOES[type]; return { type, class:d.class, o:0, shape:d.shape.map(r=>r.slice()), x:Math.floor(BOARD_WIDTH/2)-Math.floor(d.shape[0].length/2), y:-1 }; }
  function currentCells(p){ const a=[]; for(let py=0;py<p.shape.length;py++) for(let px=0;px<p.shape[py].length;px++) if(p.shape[py][px]) a.push({x:p.x+px,y:p.y+py}); return a; }
  function validAt(board,piece,X,Y,shapeOverride=null){
    const shp=shapeOverride||piece.shape;
    for(let py=0;py<shp.length;py++){
      for(let px=0;px<shp[py].length;px++){
        if(shp[py][px]){
          const x=X+px, y=Y+py;
          if(x<0||x>=BOARD_WIDTH||y>=BOARD_HEIGHT) return false;
          if(y>=0 && board[y][x]) return false;
        }
      }
    }
    return true;
  }
  function rotCW(shape){ const r=shape.length,c=shape[0].length,out=Array.from({length:c},()=>Array(r).fill(0)); for(let i=0;i<r;i++) for(let j=0;j<c;j++) out[j][r-1-i]=shape[i][j]; return out; }
  function srsRotateCW(p){
    const from=p.o,to=(p.o+1)&3; const cand=rotCW(p.shape);
    if(p.type==='O'){ if(validAt(state.board,p,p.x,p.y,cand)) return {ok:true,x:p.x,y:p.y,shape:cand,o:to,kicked:false}; return {ok:false}; }
    const table=(p.type==='I')?SRS_I:SRS_JLSTZ; const kicks=table[`${from}>${to}`];
    for(const [dx,dy] of kicks){ const nx=p.x+dx, ny=p.y+dy; if(validAt(state.board,p,nx,ny,cand)) return {ok:true,x:nx,y:ny,shape:cand,o:to,kicked:!(dx===0&&dy===0)}; }
    return {ok:false};
  }
  function ghostY(board,p){ let y=p.y; while(validAt(board,p,p.x,y+1)) y++; return y; }

  /* ---------- Hold & Next ---------- */
  function miniGrid(el,shape,cls){ el.innerHTML=''; for(let y=0;y<4;y++) for(let x=0;x<4;x++){ const c=document.createElement('div'); c.className='preview-cell'; if(shape?.[y]?.[x]) c.classList.add(cls); el.appendChild(c);} }
  function drawHold(){ const h=state.hold?TETROMINOES[state.hold.type]:null; const sh=h?h.shape:[[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0]]; miniGrid(holdBox,sh,h?h.class:''); }
  function drawNext(){ const minis=[...nextList.querySelectorAll('.mini-grid')]; for(let i=0;i<minis.length;i++){ const t=queue[i]; const d=t?TETROMINOES[t]:null; const blank=[[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0]]; miniGrid(minis[i], d?d.shape:blank, d?d.class:''); minis[i].style.display = i < state.queueSize ? 'grid' : 'none'; } }

  /* ---------- Display ---------- */
  function updateDisplay(){
    for(const el of gameBoard.querySelectorAll('.game-cell')) el.className='game-cell';
    for(let y=0;y<BOARD_HEIGHT;y++) for(let x=0;x<BOARD_WIDTH;x++){ const cls=state.board[y][x]; if(cls){ const el=gameBoard.querySelector(`[data-x="${x}"][data-y="${y}"]`); if(el) el.className=`game-cell filled ${cls}`; } }
    if(state.ghost && state.cur){ const gy=ghostY(state.board,state.cur); for(const {x,y} of currentCells({...state.cur,y:gy})){ if(y>=0){ const el=gameBoard.querySelector(`[data-x="${x}"][data-y="${y}"]`); if(el){ el.classList.add('ghost'); if(lockSince!==null) el.classList.add('lockPulse'); } } } }
    if(state.cur){ for(const {x,y} of currentCells(state.cur)){ if(y>=0){ const el=gameBoard.querySelector(`[data-x="${x}"][data-y="${y}"]`); if(el) el.className=`game-cell filled ${state.cur.class}`; } } }
    scoreEl.textContent=String(state.score); linesEl.textContent=String(state.lines); levelEl.textContent=String(state.level);
  }

  /* ---------- Gameplay ---------- */
  function popNext(){ while(queue.length<7) queue=queue.concat(newBag()); const type=queue.shift(); state.cur=spawnPiece(type); lastActionWasRotate=false; lockSince=null; drawNext(); }
  function holdSwap(){ if(!canHold||!state.cur) return; const curType=state.cur.type; if(!state.hold){ state.hold={type:curType}; popNext(); } else { const swap=state.hold.type; state.hold={type:curType}; state.cur=spawnPiece(swap); } canHold=false; drawHold(); updateDisplay(); }
  function move(dx,dy){ if(!state.cur) return false; const nx=state.cur.x+dx, ny=state.cur.y+dy; if(validAt(state.board,state.cur,nx,ny)){ state.cur.x=nx; state.cur.y=ny; if(dx!==0) SND.move(); if(dy>0 && !validAt(state.board,state.cur,nx,ny+1)) { if(lockSince===null) lockSince=performance.now(); } lastActionWasRotate=false; return true; } if(dy!==0 && lockSince===null) lockSince=performance.now(); return false; }
  function filledRows(){ const rows=[]; for(let y=0;y<BOARD_HEIGHT;y++) if(state.board[y].every(Boolean)) rows.push(y); return rows; }
  function animateClearAndApply(rows, onDone){ for(const y of rows){ for(let x=0;x<BOARD_WIDTH;x++){ const el=gameBoard.querySelector(`[data-x="${x}"][data-y="${y}"]`); if(el) el.classList.add('row-flash'); } } setTimeout(()=>{ for(const y0 of rows){ state.board.splice(y0,1); state.board.unshift(Array(BOARD_WIDTH).fill(null)); } onDone(); }, 180); }
  function isTSpin(){ if(!lastActionWasRotate || state.cur?.type!=='T') return false; const c={x:state.cur.x+1,y:state.cur.y+1}; const corners=[{x:c.x-1,y:c.y-1},{x:c.x+1,y:c.y-1},{x:c.x-1,y:c.y+1},{x:c.x+1,y:c.y+1}]; let occ=0; for(const {x,y} of corners){ if(x<0||x>=BOARD_WIDTH||y>=BOARD_HEIGHT){ occ++; continue; } if(y>=0 && state.board[y][x]) occ++; } return occ>=3; }
  function lockPiece(){
    const p=state.cur;
    for(let py=0;py<p.shape.length;py++) for(let px=0;px<p.shape[py].length;px++) if(p.shape[py][px]){ const x=p.x+px, y=p.y+py; if(y>=0) state.board[y][x]=p.class; }
    roll.locks++; lockSince=null;

    const rows=filledRows(); const tspin=isTSpin(); const hadBlocks = state.board.some(r=>r.some(Boolean));

    if(rows.length>0){
      if(tspin){ SND.tspin(); } else { SND.line(); }
      animateClearAndApply(rows, ()=>{
        let gained = LINE_SCORE[rows.length] * Math.max(1,state.level);
        if(tspin){ gained += TSPIN_BONUS; stats.tspins++; }
        if(!state.board.some(r=>r.some(Boolean)) && hadBlocks){ gained += PERFECT_CLEAR_BONUS; stats.perfects++; SND.pc(); }

        if(state.symbolic){
          const misRate = roll.mis / Math.max(1, roll.locks);
          const mult = Math.max(1, 1 + 0.15*(1 - Math.min(1, misRate)));
          gained = Math.round(gained * mult);
        }
        state.score += gained;
        state.lines += rows.length;
        state.level = Math.floor(state.lines/10)+1;

        // Play music for new level
        playMusicForLevel(state.level);

        popNext(); canHold=true;
        if(!validAt(state.board,state.cur,state.cur.x,state.cur.y)){ gameOver(); return; }
        updateDisplay();

        if(tut.practiceMode && tspin){ tutAdvance(); }
      });
    } else {
      popNext(); canHold=true;
      if(!validAt(state.board,state.cur,state.cur.x,state.cur.y)){ gameOver(); return; }
      updateDisplay();
    }
  }
  function hardDrop(){ let dist=0; while(move(0,1)) dist++; if(dist>0){ state.score += dist*HARD_POINT; roll.hard++; SND.drop(); } lockPiece(); }
  function rotateCurCW(){ if(!state.cur) return; const r=srsRotateCW(state.cur); if(r.ok){ state.cur.shape=r.shape; state.cur.x=r.x; state.cur.y=r.y; state.cur.o=r.o; lastActionWasRotate=true; lockSince=null; SND.rotate(); } else { roll.mis++; lastActionWasRotate=false; } updateDisplay(); }

  /* ---------- Adaptive ---------- */
  let adaptClock=0;
  function adaptTick(dt){
    if(!state.adaptive||state.gameOver||state.paused) return; adaptClock+=dt; if(adaptClock<12000) return; adaptClock=0;
    const age=(Date.now()-sessionStart)/1000;
    const lpm=state.lines/Math.max(1,age/60);
    const misRate=roll.mis/Math.max(1,roll.locks);
    const latency=roll.meanLatency||120;
    const comfort=(lpm/1.5)+(1-Math.min(1,misRate))+(120/Math.max(60,latency));
    if(comfort>=2.0){ LOCK_DELAY=Math.max(200,LOCK_DELAY-40); state.queueSize=Math.max(3,state.queueSize-1); }
    else { LOCK_DELAY=Math.min(800,LOCK_DELAY+40); state.ghost=true; state.queueSize=Math.min(5,Math.max(5,state.queueSize)); }
    optLock.value=String(LOCK_DELAY); drawNext();
  }

  /* ---------- Loop ---------- */
  function gravityInterval(){ return Math.max(50, INITIAL_SPEED - (state.level-1)*50); }
  let lastTs=performance.now();
  function loop(ts){
    const dt=ts-lastTs; lastTs=ts;
    if(!state.paused && !state.gameOver){
      state.acc+=dt; const g=gravityInterval();
      while(state.acc>=g){
        state.acc-=g;
        if(!move(0,1)){
          const now=performance.now();
          if(lockSince===null) lockSince=now;
          if(now-lockSince>=LOCK_DELAY){ lockPiece(); }
          break;
        }
      }
      if(state.downHeld){ if(move(0,1)){ state.score+=SOFT_POINT; roll.soft++; } }
      adaptTick(dt);
      updateDisplay();
    }
    loopHandle=requestAnimationFrame(loop);
  }

  /* ---------- Telemetry ---------- */
  function markInput(){ const now=performance.now(), dt=now-roll.lastInputAt; roll.lastInputAt=now; roll.inputs++; roll.meanLatency = roll.meanLatency===0 ? dt : 0.9*roll.meanLatency + 0.1*dt; }
  function pushClassRow(status){
    const dur=Math.round((Date.now()-sessionStart)/1000);
    const row={ ts:new Date().toISOString(), status, score:state.score, lines:state.lines, level:state.level, dur_s:dur,
      inputs:roll.inputs, latency_ms:Math.round(roll.meanLatency), soft:roll.soft, hard:roll.hard, mis:roll.mis, locks:roll.locks,
      tspins:stats.tspins, perfects:stats.perfects };
    const arr=JSON.parse(store.get(CLASS_KEY,"[]")); arr.push(row); store.set(CLASS_KEY,JSON.stringify(arr));
  }
  function exportCSV(){
    const arr=JSON.parse(store.get(CLASS_KEY,"[]"));
    if(!Array.isArray(arr)||arr.length===0){ alert("No session data to export yet."); return; }
    const cols=["ts","status","score","lines","level","dur_s","inputs","latency_ms","soft","hard","mis","locks","tspins","perfects"];
    const head=cols.join(","), body=arr.map(r=>cols.map(k=>r?.[k]??"").join(",")).join("\n");
    const blob=new Blob([head+"\n"+body],{type:"text/csv"}); const url=URL.createObjectURL(blob);
    const a=document.createElement("a"); a.href=url; a.download="mc_tetris_classlog.csv"; a.click(); URL.revokeObjectURL(url);
  }

  /* ---------- Lifecycle ---------- */
  function startGame(){
    LOCK_DELAY=+optLock.value;
    const adaptive=optAdaptive.checked, ghost=optGhost.checked, symbolic=optSymbolic.checked, qsize=+optQueue.value;
    rngSeed = optDaily.checked ? dailySeed() : ((+optSeed.value)||Math.floor(Math.random()*1e9))>>>0;

    state={ board:[], cur:null, hold:null, score:0, lines:0, level:1, paused:false, gameOver:false,
            acc:0, downHeld:false, gameStarted:true, adaptive, ghost, symbolic, queueSize:qsize };

    sessionStart=Date.now();
    stats.tspins=0; stats.perfects=0;
    roll.inputs=roll.soft=roll.hard=roll.mis=roll.locks=0; roll.meanLatency=0; roll.lastInputAt=performance.now();
    lastActionWasRotate=false;

    makeBoard(); queue=newBag(); popNext(); drawHold(); drawNext(); updateDisplay();

    startModal.classList.add('hidden'); gameOverModal.classList.add('hidden');
    startBtn.classList.add('hidden'); pauseBtn.classList.remove('hidden');

    // Start music at level 1
    playMusicForLevel(state.level);

    cancelAnimationFrame(loopHandle); lastTs=performance.now(); requestAnimationFrame(loop);
  }
  function gameOver(){
    state.gameOver=true; cancelAnimationFrame(loopHandle); SND.over();
    stopMusic();
    mustGet('finalScore').textContent=String(state.score);
    mustGet('finalLines').textContent=String(state.lines);
    mustGet('finalLevel').textContent=String(state.level);
    const secs=Math.max(1, Math.round((Date.now()-sessionStart)/1000));
    const lpm=(state.lines/(secs/60)).toFixed(1);
    mustGet('finalLPM').textContent=String(lpm);
    mustGet('finalTSpins').textContent=String(stats.tspins);
    mustGet('finalPCs').textContent=String(stats.perfects);
    gameOverModal.classList.remove('hidden'); pauseBtn.classList.add('hidden'); startBtn.classList.remove('hidden');
    pushClassRow('gameover');
  }
  function togglePause(){ 
    if(!state.gameStarted||state.gameOver) return; 
    state.paused=!state.paused; 
    if(state.paused){ 
      pauseModal.classList.remove('hidden'); 
      pauseBtn.textContent='RESUME'; 
      stopMusic();
      pushClassRow('pause'); 
    } else { 
      pauseModal.classList.add('hidden'); 
      pauseBtn.textContent='PAUSE'; 
      playMusicForLevel(state.level);
      lastTs=performance.now(); 
    } 
  }

  /* ---------- Keybinds ---------- */
  const DEFAULT_KEYS={ left:'ArrowLeft', right:'ArrowRight', down:'ArrowDown', rotate:'ArrowUp', hard:'Enter', hold:'Shift', pause:'p' };
  function loadKeys(){ return {...DEFAULT_KEYS, ...JSON.parse(store.get('mc_kb',"{}"))}; }
  function saveKeys(map){ store.set('mc_kb',JSON.stringify(map)); }
  let KEYS=loadKeys();

  function openKeybinds(){
    kb.left.value=KEYS.left; kb.right.value=KEYS.right; kb.down.value=KEYS.down; kb.rotate.value=KEYS.rotate;
    kb.hard.value=KEYS.hard; kb.hold.value=KEYS.hold; kb.pause.value=KEYS.pause;
    keysModal.classList.remove('hidden');
  }
  kb.save.addEventListener('click',()=>{
    KEYS={ left:kb.left.value||DEFAULT_KEYS.left, right:kb.right.value||DEFAULT_KEYS.right, down:kb.down.value||DEFAULT_KEYS.down,
           rotate:kb.rotate.value||DEFAULT_KEYS.rotate, hard:kb.hard.value||DEFAULT_KEYS.hard, hold:kb.hold.value||DEFAULT_KEYS.hold,
           pause:kb.pause.value||DEFAULT_KEYS.pause };
    saveKeys(KEYS); keysModal.classList.add('hidden');
  });
  kb.cancel.addEventListener('click',()=> keysModal.classList.add('hidden'));

  /* ---------- Input ---------- */
  document.addEventListener('keydown',(e)=>{
    if(!state.gameStarted){ if(e.key===' '||e.key==='Enter'){ e.preventDefault(); startGame(); } return; }
    if(state.gameOver){ if(e.key===' '||e.key==='Enter'){ e.preventDefault(); startGame(); } return; }
    const k=e.key;
    if(k===KEYS.left){ e.preventDefault(); if(state.cur){ move(-1,0); markInput(); updateDisplay(); } }
    else if(k===KEYS.right){ e.preventDefault(); if(state.cur){ move(1,0); markInput(); updateDisplay(); } }
    else if(k===KEYS.down){ e.preventDefault(); state.downHeld=true; markInput(); }
    else if(k===KEYS.rotate || k===' '){ e.preventDefault(); rotateCurCW(); markInput(); }
    else if(k===KEYS.hard){ e.preventDefault(); hardDrop(); markInput(); }
    else if(k===KEYS.hold || k==='c' || k==='C'){ e.preventDefault(); holdSwap(); markInput(); }
    else if(k.toLowerCase()===KEYS.pause.toLowerCase()){ e.preventDefault(); togglePause(); }
  });
  document.addEventListener('keyup',(e)=>{ if(e.key===KEYS.down) state.downHeld=false; });

  // Buttons
  pauseBtn.addEventListener('click',togglePause);
  rotateBtn.addEventListener('click',()=> rotateCurCW());
  dropBtn.addEventListener('click',()=> hardDrop());
  holdBtn.addEventListener('click',()=> holdSwap());
  exportBtn.addEventListener('click',()=> exportCSV());
  keysBtn.addEventListener('click',()=> openKeybinds());
  tutorialBtn.addEventListener('click',()=> openTutorial());
  [...document.querySelectorAll('.btn')].forEach(b=> b.addEventListener('touchstart', e=>{ e.preventDefault(); b.click(); }, {passive:false}));

  /* ---------- Tutorial ---------- */
  const slides = [
    { title:"Welcome", html:`<p>This short tutorial explains controls, the 7-bag randomizer, lock delay, ghost piece, SRS wall-kicks, and T-Spins.</p><p>Use the buttons below to navigate. You can exit anytime.</p>` },
    { title:"Controls", html:`<ul class="tut-list"><li>Move: <b>← →</b>, Soft Drop: <b>↓</b>, Hard Drop: <b>Enter</b></li><li>Rotate: <b>↑</b> or <b>Space</b>, Hold: <b>C</b> or <b>Shift</b></li><li>Pause: <b>P</b>. Rebind keys in <b>KEY BINDS</b>.</li></ul>` },
    { title:"7-Bag & Lock Delay", html:`<p>Pieces are dealt from shuffled sets of all 7 tetrominoes — a <b>7-bag</b>. This avoids long droughts.</p><p><b>Lock delay</b> gives you a short window to adjust a piece after it lands. We show a ghost piece that <i>pulses</i> when lock timing starts.</p>` },
    { title:"SRS & Wall-Kicks", html:`<p>We use <b>SRS</b> (Super Rotation System). When rotating near walls or stacks, the piece can "kick" sideways to complete the rotation.</p><p>This makes tight placements possible.</p>` },
    { title:"Hands-on: T-Spin Drill", html:`<p>Goal: Perform
     a <b>T-Spin Single</b>.</p><ol class="tut-list"><li>We pre-load the board with a T-slot.</li><li>Spawn a <b>T</b> piece. Rotate into the slot and lock it.</li><li>You'll see a success banner when detected.</li></ol><div style="margin-top:.6rem;display:flex;gap:.6rem;justify-content:center;"><button class="btn" id="startDrillBtn">Start Drill</button></div>` },
    { title:"Nice!", html:`<p>You completed the T-Spin drill. T-Spins give bonus points: +${TSPIN_BONUS} plus line clears.</p><p>Close tutorial and hit <b>START GAME</b>.</p>` }
  ];
  function openTutorial(){ tut.step=0; tut.active=true; tut.practiceMode=false; renderSlide(); tutorialModal.classList.remove('hidden'); }
  function closeTutorial(){ tut.active=false; tut.practiceMode=false; tutorialModal.classList.add('hidden'); if(!state.gameStarted) startModal.classList.remove('hidden'); }
  function renderSlide(){ const s=slides[tut.step]; tut.body.innerHTML=`<h3 style="margin-bottom:.5rem">${s.title}</h3>${s.html}`; tut.prev.disabled=(tut.step===0); tut.next.textContent=(tut.step===slides.length-1?"Done":"Next"); const drill=document.getElementById('startDrillBtn'); if(drill){ drill.addEventListener('click', startDrill); } }
  function tutAdvance(){ if(tut.step<slides.length-1){ tut.step++; renderSlide(); } else { closeTutorial(); } }
  function tutBack(){ if(tut.step>0){ tut.step--; renderSlide(); } }
  tut.next.addEventListener('click', ()=> tutAdvance());
  tut.prev.addEventListener('click', ()=> tutBack());
  tut.exit.addEventListener('click', ()=> closeTutorial());

  function startDrill(){
    tut.practiceMode=true; tutorialModal.classList.add('hidden');
    state = { board:[], cur:null, hold:null, score:0, lines:0, level:1, paused:false, gameOver:false, acc:0, downHeld:false, gameStarted:true, adaptive:false, ghost:true, symbolic:false, queueSize:3 };
    makeBoard();
    // Build a stack leaving a T-slot:
    for(let y=BOARD_HEIGHT-4;y<BOARD_HEIGHT;y++){
      for(let x=0;x<BOARD_WIDTH;x++){
        const leave = ((y===BOARD_HEIGHT-3 && (x===4)) || (y===BOARD_HEIGHT-2 && (x===3 || x===5)) || (y===BOARD_HEIGHT-1 && (x===4)));
        if(!leave) state.board[y][x]='color-J';
      }
    }
    queue = ['T','I','L','S','Z','J','O'];
    popNext(); state.cur.y = 14; state.cur.x = 4;
    drawHold(); drawNext(); updateDisplay();
    cancelAnimationFrame(loopHandle); lastTs=performance.now(); requestAnimationFrame(loop);
  }

  /* ---------- Theme System with Google Drive Backgrounds ---------- */
  function applyBackgroundForLevel(level){
    const imgIndex = (level - 1) % BACKGROUND_IMAGES.length;
    const imageUrl = BACKGROUND_IMAGES[imgIndex];
    document.documentElement.style.setProperty('--bg-url', `url("${imageUrl}")`);
    console.log(`🖼️ Background ${imgIndex + 1}/${BACKGROUND_IMAGES.length} for level ${level}`);
  }

  const THEMES = {
    dynamic: { name:"Dynamic (Google Drive)", isDynamic: true },
    hive:     { name:"mcHive (Default)", url:null },
    mandala:  { name:"Mandala Dawn",    url:"assets/mc_mandala.jpg" },
    beam:     { name:"Cathedral Beam",  url:"assets/mc_beam.jpg" },
    village:  { name:"Village Grove",   url:"assets/mc_village.jpg" },
    geometry: { name:"Glyph Geometry",  url:"assets/mc_geometry.jpg" },
    eye:      { name:"Sky Glyph",       url:"assets/mc_eye.jpg" },
    tree:     { name:"Harmony Tree",    url:"assets/mc_tree.jpg" },
    meadow:   { name:"Pastel Meadow",   url:"assets/mc_meadow.jpg" },
    campfire: { name:"Campfire Path",   url:"assets/mc_campfire.jpg" },
    cottage:  { name:"Field Cottage",   url:"assets/mc_cottage.jpg" }
  };
  
  let currentTheme = 'dynamic';
  
  function applyTheme(key){
    const t = THEMES[key] || THEMES.dynamic;
    currentTheme = key;
    if(t.isDynamic){
      // Use dynamic backgrounds that change per level
      applyBackgroundForLevel(state.level || 1);
    } else {
      const url = t.url ? `url("${t.url}")` : 'none';
      document.documentElement.style.setProperty('--bg-url', url);
    }
    localStorage.setItem('mc_theme', key);
  }
  
  function initThemeUI(){
    const sel=document.getElementById('themeSelect'); 
    if(!sel){ 
      const saved = localStorage.getItem('mc_theme')||'dynamic';
      applyTheme(saved); 
      return; 
    }
    sel.innerHTML = Object.entries(THEMES).map(([k,v])=>`<option value="${k}">${v.name}</option>`).join('');
    const saved=localStorage.getItem('mc_theme')||'dynamic'; 
    sel.value=saved; 
    applyTheme(saved);
    sel.addEventListener('change', e=> applyTheme(e.target.value));
  }

  /* ---------- Boot ---------- */
  try{ makeBoard(); drawHold(); drawNext(); }catch(e){ console.error(e); gameBoard.innerHTML='<div style="color:#ff5a5a;padding:1rem;text-align:center;">Load error. See console.</div>'; }
  window.startGame=startGame;
  window.openTutorial=openTutorial;
  exportBtn.addEventListener('click', exportCSV);

  // Theme init after DOM ready
  window.addEventListener('DOMContentLoaded', initThemeUI);

  // Update background when level changes (if using dynamic theme)
  const originalLockPiece = lockPiece;
  lockPiece = function(){
    const oldLevel = state.level;
    originalLockPiece.call(this);
    if(currentTheme === 'dynamic' && state.level !== oldLevel){
      applyBackgroundForLevel(state.level);
    }
  };
  </script>
</body>
</html>
